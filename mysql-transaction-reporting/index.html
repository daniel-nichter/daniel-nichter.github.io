<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>MySQL Transaction Reporting</title>
  <meta property="og:title" content="MySQL Transaction Reporting" />
  <meta name="description" content="MySQL Transaction Reporting In chapter 8 of Efficient MySQL Performance, I discuss reporting MySQL transactions (among many other related topics). In the book, I note that the state of the art is practically nonexistent: transactions are important, but we just don&rsquo;t monitor or report them in the world of MySQL. Historically (in older versions of MySQL), there was basically no way to do this because neither the general log nor the slow log printed transaction IDs.">
  <meta property="og:description" content="MySQL Transaction Reporting In chapter 8 of Efficient MySQL Performance, I discuss reporting MySQL transactions (among many other related topics). In the book, I note that the state of the art is practically nonexistent: transactions are important, but we just don&rsquo;t monitor or report them in the world of MySQL. Historically (in older versions of MySQL), there was basically no way to do this because neither the general log nor the slow log printed transaction IDs.">
  <meta name="author" content="Daniel Nichter"/>
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <meta property="og:url" content="https://hackmysql.com/mysql-transaction-reporting/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Hack MySQL" />
  <meta name="generator" content="Hugo 0.104.3" />
  <link rel="canonical" href="https://hackmysql.com/mysql-transaction-reporting/" />
  <link rel="alternate" href="https://hackmysql.com/index.xml" type="application/rss+xml" title="Hack MySQL">
  <link rel="stylesheet" href="https://hackmysql.com/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://hackmysql.com/css/atom-one-dark.css" />
  <link rel="stylesheet" href="https://hackmysql.com/css/main.css" />
</head>

  <body>
    <nav class="navbar navbar-default navbar-static-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://hackmysql.com/">Hack MySQL</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
<div id="Ukraine">
<a href="https://help.unicef.org/ukraine-emergency">UNICEF</a>&mdash;<a href="https://www.icrc.org/en/donate/ukraine">ICRC</a>&mdash;<a href="https://donate.wck.org/">WCK</a>&nbsp;
<img src="/img/Flag_of_Ukraine.svg" height="50px" style="display:inline" alt="Flag of Ukraine"></img>
</div>
      <ul class="nav navbar-nav navbar-left">


            <li>
              <a title="About" href="/about/">About</a>
            </li>



            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Archive</a>
              <div class="navlinks-children">

                  <a href="/archive/mysqlreport/">mysqlreport</a>

                  <a href="/archive/mysqlsla/">mysqlsla</a>

                  <a href="/archive/mysqlsniffer/">mysqlsniffer</a>

              </div>
            </li>



            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Engineer</a>
              <div class="navlinks-children">

                  <a href="/eng/career-advice/">Career Advice</a>

                  <a href="/eng/cli-antipatterns/">Command-line Interface Antipatterns</a>

                  <a href="/eng/database-operations-manual/">Database Operations Manual</a>

                  <a href="/eng/write/">How to Write Well</a>

                  <a href="/eng/percentiles/">Percentiles</a>

              </div>
            </li>



            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">go</a>
              <div class="navlinks-children">

                  <a href="/golang/go-antipatterns/">Go Antipatterns</a>

                  <a href="/golang/go-single-character-names/">Go Single-character Names</a>

                  <a href="/golang/idiomatic-go/">Idiomatic Go</a>

              </div>
            </li>



            <li>
              <a title="Help" href="/help/">Help</a>
            </li>



            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">MySQL</a>
              <div class="navlinks-children">

                  <a href="/mysql-password-rotation-lambda/">MySQL Password Rotation with AWS Secrets Manager and Lambda</a>

                  <a href="/mysql-select-and-sort/">MySQL Select and Sort Status Variables</a>

                  <a href="/mysql-terminology-updates/">MySQL Terminology Updates</a>

                  <a href="/mysql-transaction-reporting/">MySQL Transaction Reporting</a>

              </div>
            </li>




      </ul>
	</div>
  </div>
</nav>


<main class="page">
	<div id="art">
		<article role="main" class="blog-post"><h1 id="mysql-transaction-reporting">MySQL Transaction Reporting</h1>
<p>In chapter 8 of <a href="https://oreil.ly/efficient-mysql-performance"><em>Efficient MySQL Performance</em></a>, I discuss reporting MySQL transactions (among many other related topics).
In the book, I note that the state of the art is practically nonexistent: transactions are important, but we just don&rsquo;t monitor or report them in the world of MySQL.
Historically (in older versions of MySQL), there was basically no way to do this because neither the general log nor the slow log printed transaction IDs.
With vast improvements to the <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema.html">Performance Schema</a>, MySQL transaction report is possible but there are no tools to make it easy, as far as I know.</p>
<p>For now, the &ldquo;solution&rdquo; is copy-pasting queries like the ones below to gain insight into past and present transactions.
When time allows me, I&rsquo;ll dig into the state of this art deeper, talk with more MySQL DBAs, and see if we can&rsquo;t create better solutions.</p>
<p>See also <a href="/post/book-8/">Mining the MySQL Performance Schema for Transactions</a>.</p>
<h3 id="report-latest-query-for-transactions-active-longer-than-1-second">Report latest query for transactions active longer than 1 second</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Example 8-2. Report latest query for transactions active longer than 1 second
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  ROUND(trx.timer_wait<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000000</span>,<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">AS</span> trx_runtime,
</span></span><span style="display:flex;"><span>  trx.thread_id <span style="color:#66d9ef">AS</span> thread_id,
</span></span><span style="display:flex;"><span>  trx.event_id <span style="color:#66d9ef">AS</span> trx_event_id,
</span></span><span style="display:flex;"><span>  trx.isolation_level,
</span></span><span style="display:flex;"><span>  trx.autocommit,
</span></span><span style="display:flex;"><span>  stm.current_schema <span style="color:#66d9ef">AS</span> db,
</span></span><span style="display:flex;"><span>  stm.sql_text <span style="color:#66d9ef">AS</span> query,
</span></span><span style="display:flex;"><span>  stm.rows_examined <span style="color:#66d9ef">AS</span> rows_examined,
</span></span><span style="display:flex;"><span>  stm.rows_affected <span style="color:#66d9ef">AS</span> rows_affected,
</span></span><span style="display:flex;"><span>  stm.rows_sent <span style="color:#66d9ef">AS</span> rows_sent,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">IF</span>(stm.end_event_id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>, <span style="color:#e6db74">&#39;running&#39;</span>, <span style="color:#e6db74">&#39;done&#39;</span>) <span style="color:#66d9ef">AS</span> exec_state,
</span></span><span style="display:flex;"><span>  ROUND(stm.timer_wait<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000000</span>,<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">AS</span> exec_time
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>       performance_schema.events_transactions_current trx
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">JOIN</span> performance_schema.events_statements_current   stm <span style="color:#66d9ef">USING</span> (thread_id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span>
</span></span><span style="display:flex;"><span>      trx.<span style="color:#66d9ef">state</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ACTIVE&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> trx.timer_wait <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1000000000000</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><h3 id="report-transaction-summary">Report transaction summary</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Example 8-3. Report transaction summary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  trx.thread_id <span style="color:#66d9ef">AS</span> thread_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">MAX</span>(trx.event_id) <span style="color:#66d9ef">AS</span> trx_event_id,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">MAX</span>(ROUND(trx.timer_wait<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000000</span>,<span style="color:#ae81ff">3</span>)) <span style="color:#66d9ef">AS</span> trx_runtime,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(ROUND(stm.timer_wait<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000000</span>,<span style="color:#ae81ff">3</span>)) <span style="color:#66d9ef">AS</span> exec_time,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_examined) <span style="color:#66d9ef">AS</span> rows_examined,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_affected) <span style="color:#66d9ef">AS</span> rows_affected,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_sent) <span style="color:#66d9ef">AS</span> rows_sent
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>       performance_schema.events_transactions_current trx
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">JOIN</span> performance_schema.events_statements_history   stm
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ON</span> stm.thread_id <span style="color:#f92672">=</span> trx.thread_id <span style="color:#66d9ef">AND</span> stm.nesting_event_id <span style="color:#f92672">=</span> trx.event_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span>
</span></span><span style="display:flex;"><span>      stm.event_name <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;statement/sql/%&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> trx.<span style="color:#66d9ef">state</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ACTIVE&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> trx.timer_wait <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1000000000000</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> trx.thread_id<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</span></span></code></pre></div><h3 id="report-transaction-history">Report transaction history</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Example 8-4. Report transaction history
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  stm.rows_examined <span style="color:#66d9ef">AS</span> rows_examined,
</span></span><span style="display:flex;"><span>  stm.rows_affected <span style="color:#66d9ef">AS</span> rows_affected,
</span></span><span style="display:flex;"><span>  stm.rows_sent <span style="color:#66d9ef">AS</span> rows_sent,
</span></span><span style="display:flex;"><span>  ROUND(stm.timer_wait<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000000</span>,<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">AS</span> exec_time,
</span></span><span style="display:flex;"><span>  stm.sql_text <span style="color:#66d9ef">AS</span> query
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>  performance_schema.events_statements_history stm
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span>
</span></span><span style="display:flex;"><span>       stm.thread_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span>  stm.nesting_event_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> stm.event_id;
</span></span></code></pre></div><h3 id="report-basic-metrics-for-committed-transactions">Report basic metrics for committed transactions</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- Example 8-5. Report basic metrics for committed transactions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>  ROUND(<span style="color:#66d9ef">MAX</span>(trx.timer_wait)<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000</span>,<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">AS</span> trx_time,
</span></span><span style="display:flex;"><span>  ROUND(<span style="color:#66d9ef">SUM</span>(stm.timer_end<span style="color:#f92672">-</span>stm.timer_start)<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000</span>,<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">AS</span> query_time,
</span></span><span style="display:flex;"><span>  ROUND((<span style="color:#66d9ef">MAX</span>(trx.timer_wait)<span style="color:#f92672">-</span><span style="color:#66d9ef">SUM</span>(stm.timer_end<span style="color:#f92672">-</span>stm.timer_start))<span style="color:#f92672">/</span><span style="color:#ae81ff">1000000000</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">AS</span> idle_time,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">COUNT</span>(stm.event_id)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">AS</span> query_count,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_examined) <span style="color:#66d9ef">AS</span> rows_examined,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_affected) <span style="color:#66d9ef">AS</span> rows_affected,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">SUM</span>(stm.rows_sent) <span style="color:#66d9ef">AS</span> rows_sent
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>      performance_schema.events_transactions_history trx
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">JOIN</span> performance_schema.events_statements_history   stm
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">ON</span> stm.nesting_event_id <span style="color:#f92672">=</span> trx.event_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span>
</span></span><span style="display:flex;"><span>      trx.<span style="color:#66d9ef">state</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;COMMITTED&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> trx.nesting_event_id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span>
</span></span><span style="display:flex;"><span>  trx.thread_id, trx.event_id;
</span></span></code></pre></div></article>
	</div>
	<nav id="toc">
		<em><a href="#">MySQL Transaction Reporting</a></em>
		<hr>
		<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#report-latest-query-for-transactions-active-longer-than-1-second">Report latest query for transactions active longer than 1 second</a></li>
        <li><a href="#report-transaction-summary">Report transaction summary</a></li>
        <li><a href="#report-transaction-history">Report transaction history</a></li>
        <li><a href="#report-basic-metrics-for-committed-transactions">Report basic metrics for committed transactions</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</nav>
</main>

    <footer>
  <p class="copyright text-muted">
    Copyright 2022 Daniel Nichter
  </p>
  <p><a href="https://github.com/daniel-nichter" alt="GitHub"><img src="https://hackmysql.com/img/mark-github.svg"></a></p>
</footer>
<script src="https://hackmysql.com/js/compressed.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="https://cdn.usefathom.com/script.js" data-site="WJIYGVMB" data-canonical="false" defer></script>


  </body>
</html>
